<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Hub Pro</title>
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body class="bg-dark text-white">
    <div class="container-fluid h-100 p-0 d-flex overflow-hidden">
        <!-- Sidebar -->
        <nav id="sidebar" class="d-flex flex-column flex-shrink-0 p-3 bg-darker" style="width: 280px; border-right: 1px solid rgba(255,255,255,0.1);">
            <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
                <span class="fs-4 fw-bold"><i class="fas fa-gamepad me-2 text-primary"></i>Game Hub</span>
            </a>
            <hr>
            <ul id="library-list" class="nav flex-column mb-auto">
                <!-- Dynamically populated -->
            </ul>
            <div id="nav-downloads" class="nav-item p-2 mt-2 rounded pointer hover-bg">
                <i class="fas fa-download me-2"></i> Downloads
            </div>
            <hr>
            <div class="dropdown">
                <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
                    <img src="https://github.com/mdo.png" alt="" width="32" height="32" class="rounded-circle me-2">
                    <strong>User</strong>
                </a>
                <ul class="dropdown-menu dropdown-menu-dark text-small shadow" aria-labelledby="dropdownUser1">
                    <li><a class="dropdown-item" href="#" id="settings-btn">Settings</a></li>
                    <li><a class="dropdown-item" href="#" id="add-game-btn">Add Game</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#">Sign out</a></li>
                </ul>
            </div>
            <div id="system-stats" class="mt-3 small text-muted">
                <div>CPU: <span id="live-cpu">0%</span></div>
                <div>Ping: <span id="live-ping">-- ms</span></div>
                <div id="batteryText" class="d-none"></div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-grow-1 d-flex flex-column h-100" style="position: relative;">
            <!-- Top Bar -->
            <div class="d-flex justify-content-between align-items-center p-3 border-bottom border-secondary bg-dark-soft">
                <div class="input-group w-25">
                    <span class="input-group-text bg-transparent border-secondary text-white"><i class="fas fa-search"></i></span>
                    <input type="text" id="search-input" class="form-control bg-transparent border-secondary text-white" placeholder="Search library...">
                </div>
                <div class="d-flex gap-2">
                    <button id="refresh-btn" class="btn btn-outline-light btn-sm"><i class="fas fa-sync-alt"></i></button>
                    <button id="view-toggle-btn" class="btn btn-outline-light btn-sm"><i class="fas fa-list"></i></button>
                    <button id="update-btn" class="btn btn-warning btn-sm" style="display:none;">Update Available</button>
                </div>
                <div id="total-dl-speed" class="text-info fw-bold"></div>
            </div>

            <!-- Games View -->
            <div id="games-view-container" class="p-4 overflow-auto h-100">
                <div id="grid-view" class="row row-cols-auto g-4"></div>
                <div id="list-view" class="list-group" style="display: none;"></div>
            </div>

            <!-- Downloads View -->
            <div id="downloads-view-container" class="p-4 h-100 overflow-auto" style="display: none;">
                <h4 class="mb-4">Downloads Manager</h4>
                <div id="idm-extension-lock" class="alert alert-warning" style="display:none;">Extension Not Installed</div>
                <div id="idm-version-lock" class="alert alert-warning" style="display:none;">Extension Version Mismatch (<span id="current-ext-v"></span>)</div>
                <div id="idm-actual-content">
                    <div class="input-group mb-3">
                        <input type="text" id="downloadUrlInput" class="form-control bg-dark text-white border-secondary" placeholder="Enter download URL">
                        <button class="btn btn-primary" onclick="startDownload()">Download</button>
                    </div>
                    <div id="downloads-list" class="d-flex flex-column gap-3"></div>
                    <div id="dl-empty-state" class="text-center text-muted mt-5">No active downloads</div>
                </div>
            </div>

            <!-- Right Sidebar (Game Details) -->
            <div id="game-details-panel" class="bg-darker border-start border-secondary p-0" style="width: 300px; display: none;">
                <!-- This seems to be handled dynamically or I missed the container in script.js analysis.
                     Wait, script.js references elements like 'game-title', 'play-button'.
                     They likely reside in a detail panel. I'll add a placeholder. -->
            </div>

            <!-- Optimizer Overlay -->
            <div id="optimizer-ui-container" class="position-absolute bottom-0 end-0 p-3" style="width: 300px; display: none;"></div>

        </main>

        <!-- Detail Panel (Fixed Position or Layout?)
             Script.js updates 'game-title', 'hero-image-container', 'play-button', etc.
             Let's put a persistent right column for details.
        -->
        <aside class="d-flex flex-column bg-darker border-start border-secondary" style="width: 320px;">
            <div id="hero-image-container" style="height: 200px; background-color: #000;"></div>
            <div class="p-3">
                <h3 id="game-title" class="mb-3">Select a Game</h3>
                <div class="d-flex gap-2 mb-3">
                    <button id="play-button" class="btn btn-success flex-grow-1"><i class="fas fa-play me-2"></i> PLAY</button>
                    <button id="favorite-btn" class="btn btn-outline-light"><i class="fas fa-star"></i></button>
                    <button id="game-props-btn" class="btn btn-outline-light"><i class="fas fa-cog"></i></button>
                </div>
                <div class="small text-muted mb-3">
                    <div>Last Played: <span id="last-played">Never</span></div>
                    <div>Playtime: <span id="playtime">0h</span></div>
                    <div>Source: <span id="source-badge" class="badge bg-secondary">--</span></div>
                </div>

                <hr>
                <div class="d-grid gap-2">
                    <button id="folder-btn" class="btn btn-outline-secondary btn-sm text-start"><i class="fas fa-folder-open me-2"></i> Open Folder</button>
                    <button id="change-cover-btn" class="btn btn-outline-secondary btn-sm text-start"><i class="fas fa-image me-2"></i> Change Cover</button>
                    <button id="hide-btn" class="btn btn-outline-secondary btn-sm text-start"><i class="fas fa-eye-slash me-2"></i> Hide Game</button>
                    <button id="delete-game-btn" class="btn btn-outline-danger btn-sm text-start" style="display:none;"><i class="fas fa-trash me-2"></i> Delete</button>
                    <button id="auto-bridge-btn" class="btn btn-outline-info btn-sm text-start"><i class="fas fa-gamepad me-2"></i> DS4 Bridge</button>
                </div>
            </div>
        </aside>
    </div>

    <!-- Modals -->
    <!-- Add Game -->
    <div class="modal fade" id="addGameModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Add Non-Steam Game</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="gameNameInput" class="form-control mb-2 bg-dark text-white" placeholder="Game Name">
                    <div class="input-group">
                        <input type="text" id="gamePathInput" class="form-control bg-dark text-white" placeholder="Executable Path">
                        <button class="btn btn-secondary" id="browse-btn">Browse</button>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button class="btn btn-primary" id="save-game-btn">Add Game</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Settings</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>Integration</h6>
                    <input type="text" id="apiKeyInput" class="form-control mb-2 bg-dark text-white" placeholder="SteamGridDB API Key">
                    <input type="text" id="steamApiKeyInput" class="form-control mb-2 bg-dark text-white" placeholder="Steam Web API Key">
                    <input type="text" id="steamIdInput" class="form-control mb-2 bg-dark text-white" placeholder="Steam ID (64-bit)">

                    <h6 class="mt-3">Appearance</h6>
                    <select id="themeSelect" class="form-select bg-dark text-white">
                        <option value="default">Default</option>
                        <option value="midnight">Midnight</option>
                        <option value="cyberpunk">Cyberpunk</option>
                        <option value="christmas">Christmas</option>
                    </select>

                    <h6 class="mt-3">Extension Bridge</h6>
                    <input type="text" id="extIdInput" class="form-control mb-2 bg-dark text-white" placeholder="Chrome Extension ID">
                    <div class="input-group mb-2">
                        <input type="text" id="extPathInput" class="form-control bg-dark text-white" placeholder="Extension Local Path">
                        <button class="btn btn-secondary" onclick="openExtensionPath()">Open</button>
                    </div>
                    <button id="ext-reload-btn" class="btn btn-info w-100">Refresh Bridge</button>
                    <button id="ext-remote-update-btn" class="btn btn-outline-warning w-100 mt-2" onclick="checkRemoteExtensionUpdate()">Check Cloud Update</button>

                    <h6 class="mt-3">Downloads</h6>
                    <div class="input-group">
                        <input type="text" id="defaultDownloadPathInput" class="form-control bg-dark text-white" placeholder="Default Download Path">
                        <button class="btn btn-secondary" onclick="browseForDownloadFolder()">Browse</button>
                    </div>
                    <div class="row mt-2">
                        <div class="col"><input type="number" id="defaultSplitsInput" class="form-control bg-dark text-white" placeholder="Splits (16)"></div>
                        <div class="col"><input type="number" id="defaultConnectionsInput" class="form-control bg-dark text-white" placeholder="Conns (16)"></div>
                        <div class="col"><input type="number" id="defaultSpeedLimitInput" class="form-control bg-dark text-white" placeholder="Limit (MB/s)"></div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button class="btn btn-danger me-auto" onclick="wipeAndRescan()">Wipe DB</button>
                    <button class="btn btn-primary" id="save-settings-btn">Save & Refresh</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Controller Settings -->
    <div class="modal fade" id="controllerSettingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Controller Bridge Settings</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label>Deadzone</label>
                    <input type="range" id="deadzoneRange" class="form-range" min="0" max="0.5" step="0.01">
                    <label>Sensitivity</label>
                    <input type="range" id="sensRange" class="form-range" min="0.5" max="2.0" step="0.1">
                    <div class="form-check form-switch mt-3">
                        <input class="form-check-input" type="checkbox" id="bridgeToggle">
                        <label class="form-check-label" for="bridgeToggle">Enable Bridge Hardware</label>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button class="btn btn-primary" id="save-controller-settings-btn">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Props -->
    <div class="modal fade" id="gamePropsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Game Properties</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label>Controller Type</label>
                        <select id="controllerSelect" class="form-select bg-dark text-white">
                            <option value="None">None (Default)</option>
                            <option value="Xbox">Xbox 360</option>
                            <option value="DS4">DualShock 4</option>
                        </select>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="focusModeToggle">
                        <label class="form-check-label">Focus Mode (High Priority)</label>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button class="btn btn-primary" id="save-game-props-btn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Friends Modal -->
    <div class="modal fade" id="friendsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Steam Friends</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul id="friends-list" class="list-group list-group-flush"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Launching Overlay -->
    <div class="modal fade" id="launchingModal" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-transparent border-0 text-center">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
                <h4 class="mt-3 text-white">Launching <span id="launchingGameName">...</span></h4>
                <p class="text-muted">Optimizing system resources...</p>
            </div>
        </div>
    </div>

    <!-- Scan Overlay -->
    <div id="scan-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center; flex-direction:column;">
        <div class="spinner-border text-primary mb-3"></div>
        <h3 class="text-white">Scanning Library...</h3>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>